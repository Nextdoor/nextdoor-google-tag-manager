___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "ATTRIBUTION",
    "CONVERSIONS",
    "MARKETING"
  ],
  "id": "ndp",
  "version": 1,
  "securityGroups": [
    "NON_GOOGLE_SCRIPTS"
  ],
  "displayName": "Nextdoor Universal Pixel",
  "brand": {
    "id": "brand_nextdoor",
    "displayName": "Nextdoor Universal Pixel Template",
    "thumbnail": "data:image/jpeg;base64,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EQlk4j0YoQ4RE5/nqtkw9/xeXqjpBSIzO3eaVIxDj3w71lstclIlhkd8O1Z2t4mpQx8Ek+G/++ATwZ150adKi9YX2F/iiQxwjdlKM9mBeaZbKvoEJkjNBo/3FrlRBnPwIf8AKAYhpqrFC9rXcSvoNDg/3jvVruJX2Ghwf7x3qmx3Er7DQ4P9471TY7iV9hocH+8d6psdxK+w0OD/AHjvVNjuJX2Ghwf7x3qmx3Er7DQ4P8Rgiwmd1KalSalKalOiJEk1APnbcgI3o8ipNSpNSpNSmKhJN3A4C3QgAV+71+71+/0iQjKre7eBXhAFfu9fu9P+3paiJVZV4JO6u/k1/9kgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA\u003d"
  },
  "description": "The Nextdoor Universal Pixel helps advertisers measure the effectiveness of campaigns.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixel_id",
    "displayName": "Nextdoor Pixel ID(s)",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY",
        "errorMessage": "You must provide a Pixel ID"
      },
      {
        "type": "REGEX",
        "args": [
          "^\\s*([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}\\s*,\\s*)*([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})\\s*$"
        ],
        "errorMessage": "Invalid Pixel ID Format"
      }
    ],
    "alwaysInSummary": true,
    "help": "Support multiple pixel IDs separated by commas, such as id1,id2"
  },
  {
    "type": "RADIO",
    "name": "event_name",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard",
        "subParams": [
          {
            "type": "SELECT",
            "name": "standard_event_name",
            "displayName": "",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "ADD_TO_CART",
                "displayValue": "Add to Cart"
              },
              {
                "value": "ADD_TO_WISHLIST",
                "displayValue": "Add to Wishlist"
              },
              {
                "value": "INITIATE_CHECKOUT",
                "displayValue": "Initiate Checkout"
              },
              {
                "value": "LEAD",
                "displayValue": "Lead"
              },
              {
                "value": "PAGE_VIEW",
                "displayValue": "Page View"
              },
              {
                "value": "PURCHASE",
                "displayValue": "Purchase"
              },
              {
                "value": "SEARCH",
                "displayValue": "Search"
              },
              {
                "value": "SIGN_UP",
                "displayValue": "Sign Up"
              },
              {
                "value": "SUBSCRIBE",
                "displayValue": "Subscribe"
              },
              {
                "value": "VIEW_CONTENT",
                "displayValue": "View Content"
              }
            ],
            "simpleValueType": true,
            "alwaysInSummary": false,
            "defaultValue": "PAGE_VIEW"
          }
        ]
      },
      {
        "value": "custom",
        "displayValue": "Custom",
        "subParams": [
          {
            "type": "SELECT",
            "name": "custom_event_name",
            "displayName": "",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "CUSTOM_CONVERSION_1",
                "displayValue": "Custom Conversion 1"
              },
              {
                "value": "CUSTOM_CONVERSION_2",
                "displayValue": "Custom Conversion 2"
              },
              {
                "value": "CUSTOM_CONVERSION_3",
                "displayValue": "Custom Conversion 3"
              },
              {
                "value": "CUSTOM_CONVERSION_4",
                "displayValue": "Custom Conversion 4"
              },
              {
                "value": "CUSTOM_CONVERSION_5",
                "displayValue": "Custom Conversion 5"
              },
              {
                "value": "CUSTOM_CONVERSION_6",
                "displayValue": "Custom Conversion 6"
              },
              {
                "value": "CUSTOM_CONVERSION_7",
                "displayValue": "Custom Conversion 7"
              },
              {
                "value": "CUSTOM_CONVERSION_8",
                "displayValue": "Custom Conversion 8"
              },
              {
                "value": "CUSTOM_CONVERSION_9",
                "displayValue": "Custom Conversion 9"
              },
              {
                "value": "CUSTOM_CONVERSION_10",
                "displayValue": "Custom Conversion 10"
              }
            ],
            "simpleValueType": true,
            "subParams": [],
            "alwaysInSummary": false
          },
          {
            "type": "TEXT",
            "name": "custom_event_nickname",
            "displayName": "Nickname",
            "simpleValueType": true,
            "alwaysInSummary": false,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "help": "Provide a descriptive name for your custom conversion."
          }
        ]
      },
      {
        "value": "variable",
        "displayValue": "Variable",
        "subParams": [
          {
            "type": "SELECT",
            "name": "variable_event_name",
            "displayName": "",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true
          }
        ]
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "custom_data",
    "displayName": "Custom Data",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "order_value",
        "displayName": "Order Value",
        "simpleValueType": true,
        "help": "ISO 4217 currency followed by the total numeric value (up to two decimal places) associated with the event."
      },
      {
        "type": "TEXT",
        "name": "order_id",
        "displayName": "Order ID",
        "simpleValueType": true,
        "help": "The order ID for this transaction."
      },
      {
        "type": "PARAM_TABLE",
        "name": "product_context",
        "displayName": "Product Context",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "id",
              "displayName": "ID",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "content_name",
              "displayName": "Content Name",
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "quantity",
              "displayName": "Quantity",
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "item_price",
              "displayName": "Item Price",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "help": "A list of objects that contain the product IDs associated with the event plus information about the products."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "user_data",
    "displayName": "Advanced Matching User Attributes",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "user_attributes",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Type",
            "name": "type",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "city",
                "displayValue": "City (lowercase)"
              },
              {
                "value": "country",
                "displayValue": "Country (ISO 3166 name in lowercase)"
              },
              {
                "value": "date_of_birth",
                "displayValue": "Date of Birth (mmddyyyy)"
              },
              {
                "value": "email",
                "displayValue": "Email (lowercase)"
              },
              {
                "value": "external_id",
                "displayValue": "External ID"
              },
              {
                "value": "first_name",
                "displayValue": "First Name (lowercase, no space)"
              },
              {
                "value": "gender",
                "displayValue": "Gender (f for female, m for male, n for non-binary, or leave it empty if prefer not to say)"
              },
              {
                "value": "last_name",
                "displayValue": "Last Name (lowercase, no space)"
              },
              {
                "value": "phone_number",
                "displayValue": "Phone (no space, dash or parentheses)"
              },
              {
                "value": "state",
                "displayValue": "State (lowercase acronym, such as ca)"
              },
              {
                "value": "street_address",
                "displayValue": "Street (lowercase)"
              },
              {
                "value": "zip_code",
                "displayValue": "Postal Code"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "restricted_data_usage_options",
    "displayName": "Restricted Data Usage",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "restricted_data_usage",
        "checkboxText": "Restricted Data Usage (RDU)",
        "simpleValueType": true,
        "help": "Restrict Data Usage force this Nextdoor event to comply to regional regulations with regard to the processing and selling of user data."
      },
      {
        "type": "TEXT",
        "name": "restricted_data_usage_country",
        "displayName": "Country",
        "simpleValueType": true,
        "help": "A country that you want to associate with this data processing option. Current accepted values are\n- 1 for the United States of America",
        "enablingConditions": [
          {
            "paramName": "restricted_data_usage",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "restricted_data_usage_state",
        "displayName": "State",
        "simpleValueType": true,
        "help": "A state that you want to associate to this data processing option. Current accepted values are.\n- 1000 for California\n- 1001 for Colorado\n- 1002 for Connecticut\n- 1003 for Florida\n- 1004 for Oregon\n- 1005 for Texas\n- 1006 for Montana\n- 1007 for Delaware\n- 1008 for Nebraska\n- 1009 for New Hampshire\n- 1010 for New Jersey\n- 1011 for Utah\n- 1012 for Virginia\n- 1013 for Minnesota\n- 1014 for Tennessee\n- 1015 for Maryland\n- 1016 for Indiana\n- 1017 for Kentucky\n- 1018 for Rhode Island",
        "enablingConditions": [
          {
            "paramName": "restricted_data_usage",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "settings",
    "displayName": "More Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "event_id",
        "displayName": "Event ID",
        "simpleValueType": true,
        "help": "Set the Event ID parameter when you plan to use the same event in the Conversion API. This field helps deduplicate events coming from multiple sources."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

var log = require('logToConsole');
var callInWindow = require('callInWindow');
var callLater = require('callLater');
var copyFromWindow = require('copyFromWindow');
var createQueue = require('createQueue');
var injectScript = require('injectScript');
var makeNumber = require('makeNumber');
var makeTableMap = require('makeTableMap');
var sendPixel = require('sendPixel');
var setInWindow = require('setInWindow');
var setCookie = require('setCookie');
var sha256 = require('sha256');
var getCookieValues = require('getCookieValues');

function mergeObjects() {
    var res = {};
    for(var i = 0; i < arguments.length; ++i) {
        for(var x in arguments[i]) {
            res[x] = arguments[i][x];
        }
    }
    return res;
}

function bootstrapFn() {
  var ndp = copyFromWindow('ndp');
  if (ndp) {
    return ndp;
  }

  setInWindow('ndp', function() {
    var handler = copyFromWindow('ndp.handleRequest');
    if (handler) {
      callInWindow('ndp.handleRequest.apply', null, arguments);
    } else {
      callInWindow('ndp.queue.push', arguments);
    }
  });
  return copyFromWindow('ndp');
}

// Checks whether a given string is likely to be a cryptographic hash
const isHash = (str) => {
  const hexRegex = '/^[a-fA-F0-9]+$/';
  const length = str.length;

  const knownHexHashes = {
    32: 'MD5',
    40: 'SHA-1',
    64: 'SHA-256',
    128: 'SHA-512',
  };
  // Check hex-based hashes
  if (knownHexHashes[length] && hexRegex.test(str)) {
    return true;
  }

  return false;
};

function bootstrap() {
  var ndp = bootstrapFn();
  createQueue('ndp.queue');
  setInWindow('ndp.sendPixelByGTM', sendPixel, true);
  setInWindow('ndp.getCookieValues', getCookieValues, true);
  setInWindow('ndp.v', 1, true);

  data.integration = "gtm";
  log("data = ", data);
  var additionalInitData = (data.additional_init_data) ? makeTableMap(data.additional_init_data, 'key', 'value') : {};
  var initData = mergeObjects(data, additionalInitData);

  if (data.restricted_data_usage) {
      ndp('restrictedDataUsage', makeNumber(data.restricted_data_usage_country), makeNumber(data.restricted_data_usage_state));
  }

  if (data.user_attributes) {
    data.user_attributes.forEach(attrs => {
      const type = attrs.type;
      const value = attrs.value;
      if (type === 'email') {
        if (isHash(value)) {
          initData.user_email_hash = value;
        } else {
          initData.user_email = value;
        }
      }
    });
  }

  var multi_pixel_list = data.pixel_id.split(",").map(pid => pid.trim());
  multi_pixel_list.forEach(pixelId => {
      ndp('init', pixelId, initData);
  });

  let event_params = {pixel_ids: multi_pixel_list};
  if (data.event_id) {
    event_params.event_id = data.event_id;
  }

  if (data.event_id) {

  }

  let custom_data = {
    order_value: data.order_value,
    order_id: data.order_id,
    product_context: data.product_context,
  };

  if (data.user_attributes) {
    data.user_attributes.forEach(attrs => {
      const type = attrs.type;
      const value = attrs.value;
      custom_data[type] = value;
    });
  }

  var event_name_final = null;
  if (initData.event_name == 'standard') {
    event_name_final = initData.standard_event_name;
  } else if (initData.event_name == 'custom') {
    event_name_final = initData.custom_event_name;
    if (data.custom_event_nickname) {
      event_params.nickname = data.custom_event_nickname;
    }
  } else {
    event_name_final = initData.variable_event_name;
  }

  ndp('track', event_name_final, event_params, custom_data);

  var url = 'https://ads.nextdoor.com/public/pixel/ndp.js?id=' + multi_pixel_list[0];
  injectScript(url, data.gtmOnSuccess, data.gtmOnFailure, url);
}

bootstrap();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp.handleRequest"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp.handleRequest.apply"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp.sendPixelByGTM"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp.getCookieValues"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ndp.v"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://flask.nextdoor.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://ads.nextdoor.com/*"
              },
              {
                "type": 1,
                "string": "https://ads.nextdoor-test.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ndclid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Basic Test
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Standard Event Name
  code: "mockData = {pixel_id: '550e8400-e29b-41d4-a716-446655440000', event_name:\
    \ 'standard', standard_event_name: 'PURCHASE'};\n\nmock('copyFromWindow', key\
    \ => {\n  if (key === 'ndp') return function() {\n    if (arguments[0] === 'track')\
    \ {\n      assertThat(arguments[1], 'event name is correct').isEqualTo('PURCHASE');\n\
    \    }\n  };\n});\n     \n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: Custom Event Name
  code: "mockData = {pixel_id: '550e8400-e29b-41d4-a716-446655440000', event_name:\
    \ 'custom', custom_event_name: 'CUSTOM_CONVERSION_5', custom_event_nickname: 'test'};\n\
    \nmock('copyFromWindow', key => {\n  if (key === 'ndp') return function() {\n\
    \    if (arguments[0] === 'track') {\n      assertThat(arguments[1], 'event name\
    \ is correct').isEqualTo('CUSTOM_CONVERSION_5');\n      assertThat(arguments[2].nickname,\
    \ 'event nickname is correct').isEqualTo('test');\n    }\n  };\n});\n     \n//\
    \ Call runCode to run the template's code.\nrunCode(mockData);\n\n// Verify that\
    \ the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: Variable Event Name
  code: "mockData = {pixel_id: '550e8400-e29b-41d4-a716-446655440000', event_name:\
    \ 'variable', variable_event_name: 'add_to_cart'};\n\nmock('copyFromWindow', key\
    \ => {\n  if (key === 'ndp') return function() {\n    if (arguments[0] === 'track')\
    \ {\n      assertThat(arguments[1], 'event name is correct').isEqualTo('add_to_cart');\n\
    \    }\n  };\n});\n     \n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: Multi Pixel
  code: "mock('copyFromWindow', key => {\n  if (key === 'ndp') return function() {\n\
    \    if (arguments[0] === 'track') {\n      assertThat(arguments[2], 'Pixel ID\
    \ list is correct').isEqualTo({pixel_ids: ['550e8400-e29b-41d4-a716-446655440000',\
    \ '87429417-4f47-4a99-8d32-2080ae007119']});\n    }\n  };\n});\n     \n// Call\
    \ runCode to run the template's code.\nrunCode(mockData);\n\n// Verify that the\
    \ tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: Event ID
  code: |-
    mockData = {pixel_id: '550e8400-e29b-41d4-a716-446655440000', event_id: 'eventId'};

    mock('copyFromWindow', function(key) {
      if (key === 'ndp') {
        return function() {
          if (arguments[0] === 'track') {
            assertThat(arguments[2].event_id, 'eventID included in tracking call').isEqualTo(mockData.event_id);
          }
        };
      }
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Custom Data
  code: "// Define your mock data\nmockData = {\n  pixel_id: '550e8400-e29b-41d4-a716-446655440000',\n\
    \  event_id: 'eventId', \n  order_value: \"USD412.21\",\n  order_id: \"ID-12213\"\
    ,\n  product_context: [\n    {\n      \"id\": \"F123\",\n      \"content_name\"\
    : \"Food\",\n      \"quantity\": \"2\",\n      \"item_price\": \"8.49\"\n    },\n\
    \    {\n      \"id\": \"D124\",\n      \"content_name\": \"Drink\",\n      \"\
    quantity\": \"1\",\n      \"item_price\": \"3.99\"\n    }\n  ]\n};\n\n// Define\
    \ expected result from mock data\nconst expected_data = {\n  order_value: mockData.order_value,\n\
    \  order_id: mockData.order_id,\n  product_context: mockData.product_context\n\
    };\n\n// Mock copyFromWindow function\nmock('copyFromWindow', (key) => {\n  if(key\
    \ === 'ndp') {\n    return function() {\n      if(arguments[0] === 'track') {\n\
    \        const custom_data = {\n          order_value: arguments[3].order_value,\n\
    \          order_id: arguments[3].order_id,\n          product_context: arguments[3].product_context\n\
    \        };\n        assertThat(custom_data, 'custom data is correctly included\
    \ in tracking call').isEqualTo(expected_data);\n      }\n    };\n  }\n});\n\n\
    // Run your code (assuming your code is under runCode function)\nrunCode(mockData);\n\
    \n// Verify that the success callback was called\nassertApi('gtmOnSuccess').wasCalled();"
setup: |-
  let mockData = {
    pixel_id: '550e8400-e29b-41d4-a716-446655440000, 87429417-4f47-4a99-8d32-2080ae007119',
    event_type: 'Page View',
  };

  const scriptUrl = 'https://ads.nextdoor.com/public/pixel/ndp.js';

  // Create injectScript mock
  let success, failure;
  mock('injectScript', (url, onsuccess, onfailure) => {
    success = onsuccess;
    failure = onfailure;
    onsuccess();
  });


___NOTES___

Created on 2/17/2021, 10:38:51 AM


